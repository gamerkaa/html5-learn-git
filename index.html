<!DOCTYPE html>
<html lang="en">
<head>
<script language="javascript">
function sendJson(user, channel, jsonObject, fnsuccess) {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
      fnsuccess(jsonObject);
    }
  };

  xhr.open('POST', 'msgsys.php', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.send('user=' + user + '&channel=' + channel + '&jsondata=' + encodeURIComponent(JSON.stringify(jsonObject)) + '&method=sent');
}

function sentjson(jsonObject) {
//  alert(jsonObject.msg);
  window.txtMsg.value = '';
}

function recvJson(user, channel, fnsuccess) {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
      var jsons = xhr.responseText;
      var jsonStrs = jsons.split("\r\n\r\n");
      for (var i = 1 ; i < jsonStrs.length; ++i) fnsuccess(JSON.parse(jsonStrs[i]));
      clearTimeout(pollTimeout);
      pollJson(user,channel);
    }
    else if (xhr.readyState == 4 && xhr.status == 404) {
      clearTimeout(pollTimeout);
      pollJson(user,channel);
    }
  };

  xhr.open('POST', 'msgsys.php', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.send('user=' + user + '&channel=' + channel + '&method=get');
}

var pollTimeout;
function recvjson(jsonObject) {
  var divText = document.createElement('div');
  divText.appendChild(document.createTextNode('recved ' + jsonObject.msg));
  document.getElementById('divMessages').appendChild(divText);
}

function pollJson(user,channel) {
  pollTimeout = setTimeout(function() { recvJson(user,channel, recvjson) }, 2000);
}

function deleteJson(user, channel, fnsuccess) {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
      fnsuccess();
    }
  };

  clearTimeout(pollTimeout);

  xhr.open('POST', 'msgsys.php', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.send('user=' + user + '&channel=' + channel + '&method=delete');
}

function deletedjson() {
//  alert(jsonObject.msg);
  window.txtUser.value = '';
}

</script>
<style>
form div {
  font-size: 16px;
  width: 300px;
}
form div input {
  width: 300px;
  margin: 10px;
}
form div button {
  width: 100px;
  margin: 10px;
}
</style>
</head>
<body>
  <form>
    <div>Enter user</div><div><input id="txtUser" type="text" size="10" placeholder="Enter user"/></div>
    <div>Enter channel</div><div><input id="txtChannel" type="text" size="10" placeholder="Enter channel"/></div>
    <div><button id="poll_btn" type="button" onclick="javascript:recvJson(document.getElementById('txtUser').value,document.getElementById('txtChannel').value,recvjson);this.style['display'] = 'none';">Poll msg</button></div>
    <div><button id="delete_btn" type="button" onclick="javascript:deleteJson(document.getElementById('txtUser').value,document.getElementById('txtChannel').value,deletedjson);window.poll_btn.style['display'] = this.style['display'];">Delete User</button></div>
    <div>Enter Message</div><div><input id="txtMsg" type="text" size="10" placeholder="Enter msg"/></div>
    <div>
      <button id="send_btn" type="button" onclick="javascript:sendJson(document.getElementById('txtUser').value,document.getElementById('txtChannel').value, {msg: document.getElementById('txtMsg').value}, sentjson)">Send msg</button>
    </div>
  </form>
  <h3>Messages</h3>
  <div id="divMessages"></div>
  <script language="javascript">
    window.txtMsg.onkeypress = function(e) {
      if (e.keyCode == 13) {
        sendJson( document.getElementById('txtUser').value,
                  document.getElementById('txtChannel').value,
                  {msg: document.getElementById('txtMsg').value}, sentjson);
      }
    };
  </script>
</body>
</html>